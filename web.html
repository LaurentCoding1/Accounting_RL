<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>記帳網站</title>
    <!-- 引入 Tailwind CSS 以便快速美化頁面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/css">
        /* 基本樣式重設 */
        /* 基本樣式重設 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* 確保沒有多餘滾動條 */
        }

        /* 登入容器的樣式 */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* bg-gray-100 */
            width: 100%; /* 確保佔滿整個視窗 */
            height: 100%; /* 確保佔滿整個視窗 */
        }

        /* 當 body 有 login-screen 類別時，強制隱藏 main-content */
        .login-screen #main-content {
            display: none !important; /* 使用 !important 確保覆蓋所有其他規則 */
        }

        /* 當 body 沒有 login-screen 類別時，強制隱藏 login-container */
        body:not(.login-screen) #login-container {
            display: none !important; /* 使用 !important 確保覆蓋所有其他規則 */
        }

        /* 主要內容 (iframe) 的容器樣式 */
        #main-content {
            width: 100%;
            height: 100%;
            display: block; /* 預設為 block，但會被 .login-screen #main-content 覆蓋 */
        }

        #main-content iframe {
            display: block;
            width: 100vw;
            height: 100vh;
            border: none;
            margin: 0;
            padding: 0;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 登出按鈕樣式 */
        #logout-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
    <script>
        // 添加從 iframe 來的消息監聽器
        window.addEventListener('message', function(event) {
            // 確保消息來源是可信的 Google Apps Script
            if (event.origin.includes('script.google.com')) {
                if (event.data && event.data.type === 'alert') {
                    // 這裡可以使用更美觀的 modal 取代 alert
                    alert(event.data.message);
                }
            }
        });
    </script>
</head>

<!-- 預設為登入畫面的樣式 -->
<body class="login-screen">

    <!-- 登入區塊 -->
    <div id="login-container" class="max-w-md w-full text-center bg-white p-8 rounded-lg shadow-md mx-4">
        <h1 class="text-2xl font-bold mb-4">歡迎使用記帳網站</h1>
        <p class="text-gray-600 mb-6">請使用您的 Google 帳號登入以繼續。</p>
        
        <div id="g_id_onload"
             data-client_id="410678975290-8oi970a6a8rhmvdbl4crf3tmfqkbcj6h.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="filled_blue"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>

        <div id="unauthorized-message" class="hidden mt-4 text-red-500 font-semibold">
            抱歉，您的帳號未被授權使用此服務。
        </div>
    </div>

    <!-- 主要內容區塊 (預設隱藏)，包含您的 iframe -->
    <div id="main-content" class="hidden">
        <iframe 
            src="https://script.google.com/macros/s/AKfycbwl38TSsHC8i3fXeD4MK0hSPmFN4uqLLXImzs_ytlGWvhDBgrrgkq3tvfeRRpNanPIQ/exec" 
            frameborder="0"
            allowfullscreen
            allow="fullscreen; modals; alerts"
            scrolling="yes"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-top-navigation">
        </iframe>
        <!-- 浮動登出按鈕 -->
        <button id="logout-button" onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300">
            登出
        </button>
    </div>

    <!-- 引入 Google Identity Services 的 JavaScript -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // --- 授權 Email 清單 ---
        const allowedEmails = [
            "lhk0972621304@gmail.com" // 請換成您自己的 email  // 可以加入更多授權 email
        ];

        // 當頁面載入時，檢查 sessionStorage 是否有登入紀錄
        window.onload = function() {
            const userIsLoggedIn = sessionStorage.getItem('userIsLoggedIn');
            const userEmail = sessionStorage.getItem('userEmail');
            if (userIsLoggedIn === 'true' && userEmail && isEmailAllowed(userEmail)) {
                console.log('偵測到已登入狀態，直接顯示內容。');
                showContent(userEmail);
            } else {
                console.log('使用者未登入或 session 已過期。');
            }
        };

        // Google 登入成功後的回呼函式
        function handleCredentialResponse(response) {
            const decodedToken = jwt_decode(response.credential);
            const userEmail = decodedToken.email;
            
            if (isEmailAllowed(userEmail)) {
                console.log(`帳號 ${userEmail} 驗證通過。`);
                sessionStorage.setItem('userIsLoggedIn', 'true');
                sessionStorage.setItem('userEmail', userEmail);
                showContent(userEmail);
            } else {
                console.log(`帳號 ${userEmail} 驗證失敗，非授權使用者。`);
                showUnauthorizedMessage();
            }
        }

        // 檢查 Email 是否在允許清單中
        function isEmailAllowed(email) {
            return allowedEmails.includes(email);
        }

        // 顯示主要內容 (iframe)
        function showContent(email) {
            // 移除 body 的登入畫面樣式
            document.body.classList.remove('login-screen');
            
            // 隱藏登入容器
            document.getElementById('login-container').classList.add('hidden');
            
            // 顯示主要內容容器 (iframe)
            document.getElementById('main-content').classList.remove('hidden');
        }

        // 顯示未授權訊息
        function showUnauthorizedMessage() {
            document.getElementById('unauthorized-message').classList.remove('hidden');
        }

        // 登出函式
        function logout() {
            sessionStorage.removeItem('userIsLoggedIn');
            sessionStorage.removeItem('userEmail');
            google.accounts.id.disableAutoSelect();
            location.reload();
        }

        // 簡易的 JWT 解碼函式
        function jwt_decode(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }
    </script>

</body>
</html>
